name: Integration Tests (Docker)

on:
  push:
    branches: [ main ]
    paths:
      - "src/**"
      - "Dockerfile"
      - "docker-compose.yml"
      - ".github/workflows/test-integration.yml"
  workflow_dispatch:

env:
  DOTNET_VERSION: '10.0.x'
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}/clamav-api

jobs:
  integration-tests:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: read
    
    services:
      # Run ClamAV daemon for the API to connect to
      clamav:
        image: clamav/clamav:latest
        ports:
          - 3310:3310
        options: >-
          --health-cmd="clamscan --version"
          --health-interval=30s
          --health-timeout=10s
          --health-retries=3
          --health-start-period=40s

    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Build Docker Image
        run: |
          docker build -t ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }} .

      - name: Start Application Container
        run: |
          docker run -d \
            --name clamav-api \
            -p 5000:8080 \
            -e CLAMAV_HOST=clamav \
            -e CLAMAV_PORT=3310 \
            --network host \
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
          
          # Wait for application to be healthy
          for i in {1..30}; do
            if curl -s http://localhost:5000/health > /dev/null; then
              echo "Application is healthy"
              exit 0
            fi
            echo "Waiting for application to start... ($i/30)"
            sleep 2
          done
          echo "Application failed to start"
          docker logs clamav-api
          exit 1

      - name: Run Integration Tests Against Running Container
        env:
          CONTAINER_BASE_URL: http://localhost:5000
        run: |
          dotnet test src/Arcus.ClamAV.Tests/Arcus.ClamAV.Tests.csproj \
            --filter "Category=BlackBox" \
            --verbosity normal \
            --logger "trx;LogFileName=blackbox-test-results.trx" \
            --configuration Release \
            -- --no-build

      - name: Publish Integration Test Results
        if: always()
        uses: EnricoMi/publish-unit-test-result-action@v2
        with:
          files: '**/blackbox-test-results.trx'
          check_name: BlackBox Test Results

      - name: Container Logs on Failure
        if: failure()
        run: |
          echo "=== ClamAV API Logs ==="
          docker logs clamav-api || true
          echo "=== ClamAV Daemon Logs ==="
          docker logs clamav || true

      - name: Cleanup
        if: always()
        run: |
          docker stop clamav-api || true
          docker rm clamav-api || true
