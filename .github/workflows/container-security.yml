name: Container Security Scanning

on:
  push:
    branches: [ main ]
    paths:
      - "Dockerfile"
      - "docker-compose.yml"
      - ".github/workflows/container-security.yml"
  pull_request:
    branches: [ main ]
    paths:
      - "Dockerfile"
      - "docker-compose.yml"

permissions:
  contents: read
  security-events: write

jobs:
  hadolint:
    name: Dockerfile Lint
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Run hadolint
        uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: Dockerfile
          failure-threshold: warning
          format: sarif
          output-file: hadolint-results.sarif

      - name: Upload hadolint Results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: hadolint-results.sarif
          tool_name: hadolint
          wait_for_processing: true

  trivy-image:
    name: Trivy Image Scan
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Build Docker Image
        run: |
          docker build -t clamav-api:scan-test .

      - name: Run Trivy Vulnerability Scan
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: clamav-api:scan-test
          format: sarif
          output: trivy-container-results.sarif
          severity: CRITICAL,HIGH

      - name: Upload Trivy Container Scan Results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: trivy-container-results.sarif
          tool_name: Trivy
          category: container-scan

  trivy-dockerfile:
    name: Trivy Dockerfile Scan
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Run Trivy on Dockerfile
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'config'
          scan-ref: 'Dockerfile'
          format: sarif
          output: trivy-dockerfile-results.sarif
          severity: CRITICAL,HIGH

      - name: Upload Trivy Dockerfile Scan Results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: trivy-dockerfile-results.sarif
          tool_name: Trivy
          category: dockerfile-scan

  container-security-summary:
    name: Container Security Summary
    runs-on: ubuntu-latest
    needs: [hadolint, trivy-image, trivy-dockerfile]
    if: always()

    steps:
      - name: Generate Summary
        run: |
          echo "## Container Security Scan Results"
          echo "✓ hadolint: Dockerfile best practices check"
          echo "✓ Trivy Image: Container image vulnerability scan"
          echo "✓ Trivy Config: Dockerfile misconfiguration scan"
          echo ""
          echo "**Note:** All results uploaded to GitHub Security Tab"

      - name: Fail if Critical Vulnerabilities Found
        if: failure()
        run: |
          echo "⚠️ Critical or High severity vulnerabilities detected!"
          echo "Please review and address them before merging."
          exit 1
